---
id: Uto-1077
status: closed
deps: []
links: []
created: 2026-02-28T23:14:40Z
type: task
priority: 2
assignee: Jamie Walls
---
# Province Logs: count and display Propaganda op count on heading line

The Province Logs Thievery Summary currently outputs the Propaganda sub-section as:

```
  Propaganda:
    49 wizards
    30 specialist troops
    28 elites
    23 thieves
```

The heading has no count. Add an op count so it reads:

```
  5 Propaganda:
    49 wizards
    30 specialist troops
    28 elites
    23 thieves
```

where `5` is the number of successful Propaganda operations cast (not the
total number of troops converted).

---

## Root cause

In `formatProvinceLogs` (`js/parser.js`), `thieveryCounts["Propaganda"]` is
never incremented — only `propagandaCounts[troopType]` (the troop totals) is
updated on each match. In the output section the `count` variable for
Propaganda is overridden to `Object.values(propagandaCounts).reduce(...)`,
giving the total troops, not the op count.

---

## Implementation — `js/parser.js`, `formatProvinceLogs`

### 1. Increment op count in the parse loop (~line 568)

Inside the `if (op.name === "Propaganda" && op.unique_impact)` block,
add a `thieveryCounts["Propaganda"]++` call when a match is found:

```javascript
// Before
const m = line.match(/We have converted .../i);
if (m) {
    const troopCount = ...;
    const key = namedTroop || 'elites';
    propagandaCounts[key] = (propagandaCounts[key] || 0) + troopCount;
}

// After
const m = line.match(/We have converted .../i);
if (m) {
    thieveryCounts["Propaganda"]++;          // ← add this
    const troopCount = ...;
    const key = namedTroop || 'elites';
    propagandaCounts[key] = (propagandaCounts[key] || 0) + troopCount;
}
```

### 2. Remove the Propaganda count override in the output section (~line 794)

Once `thieveryCounts["Propaganda"]` is properly counted, the special-case
override is no longer needed:

```javascript
// Before
if (op.unique_impact) {
    if (op.name === "Propaganda") {
        count = Object.values(propagandaCounts).reduce((a, b) => a + b, 0);
    }
}

// After — remove the Propaganda override block entirely; the general
// `count = thieveryCounts[op.name]` already gives the op count.
```

### 3. Update the Propaganda heading output (~line 810)

```javascript
// Before
output += `  Propaganda:\n`;

// After
output += `  ${count} Propaganda:\n`;
```

---

## Tests

Update `tests/provincelogs_expected_output.txt`: the `Propaganda:` heading
line becomes `N Propaganda:` where N is the actual op count from the test
data. Run `tests/province-logs.test.js` and verify the main parsing test
passes.

Note: the sort position of Propaganda in `opTotals` may shift because the
sort key changes from total troops converted (e.g. 130) to op count (e.g. 5).
Verify the section order in the expected output is still correct after the
change.
